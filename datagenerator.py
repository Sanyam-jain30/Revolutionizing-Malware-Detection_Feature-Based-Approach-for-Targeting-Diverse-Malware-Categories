import time, os
import requests, json
import pandas as pd

f = open('result.json')
listsha = json.load(f)

prev = pd.read_csv('result.csv')
res = []
keys = 10

for key in list(listsha.keys())[10:]:
    keys += 1
    count = 0
    for hash in listsha[key]:
        count += 1
        df = {}
        url = "https://mb-api.abuse.ch/api/v1/"
        data = {
            "query": "get_info",
            "hash": hash
        }

        if count%200 == 0:
            time.sleep(2)

        response = requests.post(url, data=data)

        if response.status_code == 200:
            print(count, keys)
            df["sha256_hash"] = response.json()["data"][0]["sha256_hash"]
            df["sha3_384_hash"] = response.json()["data"][0]["sha3_384_hash"]
            df["sha1_hash"] = response.json()["data"][0]["sha1_hash"]
            df["md5_hash"] = response.json()["data"][0]["md5_hash"]
            df["first_seen"] = response.json()["data"][0]["first_seen"]
            df["last_seen"]= response.json()["data"][0]["last_seen"]
            df["file_name"] = response.json()["data"][0]["file_name"]
            df["file_size"] = response.json()["data"][0]["file_size"]
            df["file_type_mime"] = response.json()["data"][0]["file_type_mime"]
            df["file_type"] = response.json()["data"][0]["file_type"]
            df["origin_country"] = response.json()["data"][0]["origin_country"]
            df["anonymous"] = response.json()["data"][0]["anonymous"]
            df["imphash"] = response.json()["data"][0]["imphash"]
            df["tlsh"] = response.json()["data"][0]["tlsh"]
            df["telfhash"] = response.json()["data"][0]["telfhash"]
            df["gimphash"] = response.json()["data"][0]["gimphash"]
            df["ssdeep"] = response.json()["data"][0]["ssdeep"]
            df["dhash_icon"] = response.json()["data"][0]["dhash_icon"]
            df["archive_pw"] = response.json()["data"][0]["archive_pw"]
            df["code_sign"] = response.json()["data"][0]["code_sign"]
            df["delivery_method"] = response.json()["data"][0]["delivery_method"]

            if response.json()["data"][0]["tags"] is not None:
                for tag in response.json()["data"][0]["tags"]:
                    df["tags " + tag] = tag

            i = 1
            if response.json()["data"][0]["file_information"] is not None:
                for file_info in response.json()["data"][0]["file_information"]:
                    df["context " + str(i)] = file_info["context"]
                    df["value " + str(i)] = file_info["value"]
                    i += 1

            df["ole_information"] = response.json()["data"][0]["ole_information"]

            i = 1
            if response.json()["data"][0]["yara_rules"] is not None:
                for yarn in response.json()["data"][0]["yara_rules"]:
                    df["rule_name " + str(i)] = yarn["rule_name"]
                    df["author " + str(i)] = yarn["author"]
                    df["description " + str(i)] = yarn["description"]
                    df["reference " + str(i)] = yarn["reference"]
                    i += 1

            i = 1
            if response.json()["data"][0]["comments"] is not None:
                for comment in response.json()["data"][0]["comments"]:
                    df["date_added " + str(i)] = comment["date_added"]
                    df["display_name " + str(i)] = comment["display_name"]
                    df["comment " + str(i)] = comment["comment"]
                    i += 1

            df["malware"] = key
            res.append(df)

        else:
            # Something went wr ong with the request
            print(f"Error: {response.status_code} - {response.text}")

    file_csv = pd.concat([prev, pd.DataFrame(res)])
    print(file_csv.head())
    print(file_csv.shape)
    file_csv.to_csv('result.csv')